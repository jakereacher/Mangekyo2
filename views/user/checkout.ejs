<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Mangeyko</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        .checkout-step {
            @apply relative pb-8;
        }
        .checkout-step:not(:last-child):after {
            content: '';
            @apply absolute left-4 top-4 h-full w-0.5 bg-gray-300;
        }
        .checkout-step.completed .step-number {
            @apply bg-green-500 text-white;
        }
        .checkout-step.active .step-number {
            @apply bg-black text-white;
        }
        .checkout-step.inactive .step-number {
            @apply bg-gray-200 text-gray-600;
        }
        .address-card {
            transition: all 0.3s ease;
        }
        .address-card:hover {
            transform: translateY(-2px);
        }
        .address-card.selected {
            border-left: 4px solid black;
        }
        .payment-method:hover {
            background-color: #f9fafb;
        }
        .payment-method.selected {
            border-color: black;
            background-color: #f3f4f6;
        }
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-black mb-4"></div>
            <p class="text-lg font-medium">Processing your order...</p>
            <p class="text-sm text-gray-500 mt-2">Press ESC to cancel if stuck</p>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-gray-800">
                <i class="fas fa-store mr-2"></i> Mangeyko
            </a>
            <div class="flex items-center space-x-6">
                <a href="/profile" class="text-gray-600 hover:text-gray-800 transition">Profile</a>
                <a href="/cart" class="text-gray-600 hover:text-gray-800 transition">
                    <i class="fas fa-shopping-cart"></i> Cart
                </a>
                <a href="/logout" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Main Checkout Content -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Column - Checkout Steps -->
            <div class="lg:w-2/3">
                <!-- Step 1: Address Selection -->
                <div id="addressStep" class="bg-white p-6 rounded-lg shadow-sm mb-6 <%= currentStep !== 1 ? 'hidden' : '' %>">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-map-marker-alt mr-2"></i>Select Delivery Address
                    </h2>

                    <!-- Address Selection -->
                    <div class="space-y-4 mb-6" id="addressSelection">
                        <% if (addresses && addresses.length > 0) { %>
                            <% addresses.forEach(address => { %>
                                <div class="address-card bg-white p-4 rounded border border-gray-200 cursor-pointer <%= address.isDefault ? 'selected' : '' %>"
                                     onclick="selectAddress('<%= address._id %>')"
                                     data-address-id="<%= address._id %>">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-bold"><%= address.fullName %></h3>
                                            <p class="text-gray-700"><%= address.addressLine %><%= address.landmark ? ', ' + address.landmark : '' %></p>
                                            <p class="text-gray-700"><%= address.city %>, <%= address.state %> - <%= address.pinCode %></p>
                                            <p class="text-gray-700">Mobile: <%= address.mobile %></p>
                                        </div>
                                        <% if (address.isDefault) { %>
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                                                Default
                                            </span>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-center">
                                <p class="text-yellow-800">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    No addresses found. Please add an address in your profile.
                                </p>
                                <a href="/profile" class="inline-block mt-2 text-blue-600 hover:underline">
                                    Go to Profile to Add Address
                                </a>
                            </div>
                        <% } %>
                    </div>

                    <!-- Add New Address Button -->
                    <button onclick="showAddressModal()"
                            class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200 transition flex items-center mb-6">
                        <i class="fas fa-plus mr-2"></i> Add New Address
                    </button>

                    <!-- Continue to Payment Button -->
                    <div class="flex justify-end">
                        <button id="continueToPayment"
                                class="bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition <%= addresses && addresses.length > 0 ? '' : 'opacity-50 cursor-not-allowed' %>"
                                <%= addresses && addresses.length > 0 ? '' : 'disabled' %>>
                            Continue to Payment
                        </button>
                    </div>
                </div>

                <!-- Step 2: Payment Method -->
                <div id="paymentStep" class="bg-white p-6 rounded-lg shadow-sm mb-6 <%= currentStep !== 2 ? 'hidden' : '' %>">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-credit-card mr-2"></i>Select Payment Method
                    </h2>

                    <div class="space-y-3 mb-6">
                        <!-- Cash on Delivery -->
                        <div class="payment-method p-4 border rounded cursor-pointer"
                             onclick="selectPaymentMethod('cod')"
                             data-method="cod">
                            <div class="flex items-center">
                                <div class="mr-4">
                                    <input type="radio" name="paymentMethod" id="cod" class="h-4 w-4 text-black focus:ring-black">
                                </div>
                                <div>
                                    <label for="cod" class="font-medium">Cash on Delivery (COD)</label>
                                    <p class="text-sm text-gray-600 mt-1">Pay when you receive your order</p>
                                </div>
                            </div>
                        </div>

                        <!-- Razorpay -->
                        <div class="payment-method p-4 border rounded cursor-pointer"
                             onclick="selectPaymentMethod('razorpay')"
                             data-method="razorpay">
                            <div class="flex items-center">
                                <div class="mr-4">
                                    <input type="radio" name="paymentMethod" id="razorpay" class="h-4 w-4 text-black focus:ring-black">
                                </div>
                                <div>
                                    <label for="razorpay" class="font-medium">Razorpay</label>
                                    <p class="text-sm text-gray-600 mt-1">Pay securely with Razorpay</p>
                                </div>
                            </div>
                        </div>

                        <!-- Wallet -->
                        <div class="payment-method p-4 border rounded cursor-pointer"
                             onclick="selectPaymentMethod('wallet')"
                             data-method="wallet">
                            <div class="flex items-center">
                                <div class="mr-4">
                                    <input type="radio" name="paymentMethod" id="wallet" class="h-4 w-4 text-black focus:ring-black">
                                </div>
                                <div>
                                    <label for="wallet" class="font-medium">Wallet Balance</label>
                                    <p class="text-sm text-gray-600 mt-1">Use your wallet balance ($<%= user.wallet ? user.wallet.toFixed(2) : '0.00' %> available)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Back and Continue Buttons -->
                    <div class="flex justify-between">
                        <button onclick="goToStep(1)"
                                class="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button id="continueToReview"
                                class="bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition">
                            Review Order
                        </button>
                    </div>
                </div>

                <!-- Step 3: Review Order -->
                <div id="reviewStep" class="bg-white p-6 rounded-lg shadow-sm <%= currentStep !== 3 ? 'hidden' : '' %>">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-clipboard-check mr-2"></i>Review Your Order
                    </h2>

                    <!-- Selected Address -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2 flex items-center">
                            <i class="fas fa-truck mr-2"></i>Delivery Address
                        </h3>
                        <div id="selectedAddressDisplay" class="bg-gray-50 p-4 rounded border border-gray-200">
                            <!-- Address will be populated here by JavaScript -->
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2 flex items-center">
                            <i class="fas fa-credit-card mr-2"></i>Payment Method
                        </h3>
                        <div id="selectedPaymentDisplay" class="bg-gray-50 p-4 rounded border border-gray-200">
                            <!-- Payment method will be populated here by JavaScript -->
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div>
                        <h3 class="font-bold text-lg mb-2 flex items-center">
                            <i class="fas fa-shopping-bag mr-2"></i>Order Summary
                        </h3>
                        <div class="bg-gray-50 p-4 rounded border border-gray-200">
                            <div class="space-y-4">
                                <% cartItems.forEach(item => { %>
                                    <div class="flex items-start pb-4 border-b border-gray-200 last:border-0">
                                        <div class="w-16 h-16 bg-gray-100 rounded overflow-hidden mr-4">
                                            <img src="/uploads/product-images/<%= item.product.productImage[0] %>" alt="<%= item.product.productName %>" class="w-full h-full object-cover">
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-medium"><%= item.product.productName %></h4>
                                            <p class="text-sm text-gray-600">Quantity: <%= item.quantity %></p>
                                            <p class="text-sm text-gray-600">Price: $<%= item.price.toFixed(2) %></p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium">$<%= item.totalPrice.toFixed(2) %></p>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>

                    <!-- Back and Place Order Buttons -->
                    <div class="flex justify-between mt-6">
                        <button onclick="goToStep(2)"
                                class="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button id="placeOrderBtn"
                                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition flex items-center">
                            <i class="fas fa-check-circle mr-2"></i> Place Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="lg:w-1/3">
                <div class="bg-white p-6 rounded-lg shadow-sm sticky top-4">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-receipt mr-2"></i>Order Summary
                    </h2>

                    <!-- Coupon Code Section -->
                    <div class="mb-4">
                        <label for="couponCode" class="block text-sm font-medium text-gray-700">Apply Coupon Code</label>
                        <div class="flex mt-2">
                            <input type="text" id="couponCode" class="flex-1 px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-2 focus:ring-black" placeholder="Enter coupon code">
                            <button id="applyCouponBtn" class="px-4 py-2 bg-black text-white rounded-r hover:bg-gray-800 transition">Apply</button>
                        </div>
                        <p id="couponMessage" class="text-sm mt-2"></p>
                    </div>

                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (<%= cartCount %> items)</span>
                            <span>$<%= subtotal %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping</span>
                            <span>$<%= shipping %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tax</span>
                            <span>$<%= tax %></span>
                        </div>
                        <div id="discountSection" class="hidden">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Discount</span>
                                <span id="discountAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mb-4">
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total</span>
                            <span id="finalTotal">$<%= total %></span>
                        </div>
                    </div>

                    <!-- Order Summary Items (for mobile) -->
                    <div class="lg:hidden border-t border-gray-200 pt-4 mt-4">
                        <h3 class="font-bold mb-2">Your Items</h3>
                        <div class="space-y-3 max-h-60 overflow-y-auto">
                            <% cartItems.forEach(item => { %>
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gray-100 rounded overflow-hidden mr-3">
                                        <img src="/uploads/product-images/<%= item.product.productImage[0] %>" alt="<%= item.product.productName %>" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium"><%= item.product.productName %></p>
                                        <p class="text-xs text-gray-600">Qty: <%= item.quantity %></p>
                                    </div>
                                    <div class="text-sm font-medium">
                                        $<%= item.totalPrice.toFixed(2) %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Modal -->
    <div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2"></i>Add New Address
                </h2>

                <form id="addressForm" class="space-y-4">
                    <div>
                        <label for="fullName" class="form-label">
                            <i class="fas fa-user mr-2"></i>Full Name
                        </label>
                        <input type="text" id="fullName" name="fullName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                               placeholder="Enter recipient's full name">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="mobile" class="form-label">
                                <i class="fas fa-phone-alt mr-2"></i>Mobile Number
                            </label>
                            <input type="tel" id="mobile" name="mobile" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                                   placeholder="10-digit mobile number">
                        </div>
                        <div>
                            <label for="pinCode" class="form-label">
                                <i class="fas fa-map-pin mr-2"></i>PIN Code
                            </label>
                            <input type="text" id="pinCode" name="pinCode" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                                   placeholder="6-digit PIN code">
                        </div>
                    </div>

                    <div>
                        <label for="addressLine" class="form-label">
                            <i class="fas fa-home mr-2"></i>Address Line
                        </label>
                        <textarea id="addressLine" name="addressLine" rows="3" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                                  placeholder="House No., Building, Street, Area"></textarea>
                    </div>

                    <div>
                        <label for="landmark" class="form-label">
                            <i class="fas fa-landmark mr-2"></i>Landmark (Optional)
                        </label>
                        <input type="text" id="landmark" name="landmark"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                               placeholder="Nearby location for easier navigation">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="city" class="form-label">
                                <i class="fas fa-city mr-2"></i>City
                            </label>
                            <input type="text" id="city" name="city" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                                   placeholder="Your city">
                        </div>
                        <div>
                            <label for="state" class="form-label">
                                <i class="fas fa-map mr-2"></i>State
                            </label>
                            <input type="text" id="state" name="state" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
                                   placeholder="Your state">
                        </div>
                    </div>

                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="isDefault" name="isDefault"
                               class="h-4 w-4 text-black focus:ring-black border-gray-300 rounded">
                        <label for="isDefault" class="ml-2 block text-sm text-gray-700">
                            Set as default delivery address
                        </label>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideAddressModal()"
                                class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition flex items-center">
                            <i class="fas fa-times mr-2"></i> Cancel
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition flex items-center">
                            <i class="fas fa-save mr-2"></i> Save Address
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store checkout data
        let selectedAddressId = '<%= defaultAddress ? defaultAddress._id : "" %>';
        let selectedPaymentMethod = '';
        let appliedCoupon = null; // Declare and initialize appliedCoupon
        let currentTotal = parseFloat('<%= total %>'); // Declare and initialize currentTotal
        let checkoutData = {
            addressId: selectedAddressId,
            paymentMethod: '',
            couponCode: null
        };

        // Global function to hide the loading overlay
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
            console.log('Loading overlay hidden');
        }

        // Global function to show the loading overlay
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            console.log('Loading overlay shown');
        }

        // Add event listener to hide loading overlay when page is about to be unloaded
        window.addEventListener('beforeunload', function() {
            hideLoadingOverlay();
        });

        // Add keyboard shortcut (Escape key) to hide loading overlay in case it gets stuck
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && document.getElementById('loadingOverlay').style.display === 'flex') {
                console.log('Escape key pressed: Hiding loading overlay');
                hideLoadingOverlay();
            }
        });

        // Add click handler to loading overlay to hide it when clicked
        document.getElementById('loadingOverlay').addEventListener('click', function(event) {
            // Only hide if clicking directly on the overlay (not on its children)
            if (event.target === this) {
                console.log('Loading overlay clicked: Hiding loading overlay');
                hideLoadingOverlay();
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // If we have a default address, select it
            if (selectedAddressId) {
                const addressCard = document.querySelector(`[data-address-id="${selectedAddressId}"]`);
                if (addressCard) {
                    addressCard.classList.add('selected');
                }
            }

            // Set up event listeners
            document.getElementById('continueToPayment').addEventListener('click', function() {
                if (!selectedAddressId) {
                    Swal.fire('Error', 'Please select a delivery address', 'error');
                    return;
                }
                goToStep(2);
            });

            document.getElementById('continueToReview').addEventListener('click', function() {
                if (!selectedPaymentMethod) {
                    Swal.fire('Error', 'Please select a payment method', 'error');
                    return;
                }
                checkoutData.paymentMethod = selectedPaymentMethod;
                updateReviewStep();
                goToStep(3);
            });

            document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);

            // Address form submission
            document.getElementById('addressForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = {
                    fullName: document.getElementById('fullName').value,
                    mobile: document.getElementById('mobile').value,
                    pinCode: document.getElementById('pinCode').value,
                    addressLine: document.getElementById('addressLine').value,
                    landmark: document.getElementById('landmark').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    isDefault: document.getElementById('isDefault').checked,
                    action: 'ADD'
                };

                try {
                    const response = await fetch('/profile/addresses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        hideAddressModal();
                        // Refresh addresses
                        const addressesContainer = document.getElementById('addressSelection');
                        if (result.data.length > 0) {
                            let html = '';
                            result.data.forEach(address => {
                                html += `
                                    <div class="address-card bg-white p-4 rounded border border-gray-200 cursor-pointer ${address.isDefault ? 'selected' : ''}"
                                         onclick="selectAddress('${address._id}')"
                                         data-address-id="${address._id}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h3 class="font-bold">${address.fullName}</h3>
                                                <p class="text-gray-700">${address.addressLine}${address.landmark ? ', ' + address.landmark : ''}</p>
                                                <p class="text-gray-700">${address.city}, ${address.state} - ${address.pinCode}</p>
                                                <p class="text-gray-700">Mobile: ${address.mobile}</p>
                                            </div>
                                            ${address.isDefault ? `
                                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                                                    Default
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            addressesContainer.innerHTML = html;

                            // Select the new address if it's default
                            if (formData.isDefault) {
                                const newAddressId = result.data.find(addr => addr.isDefault)?._id;
                                if (newAddressId) {
                                    selectAddress(newAddressId);
                                }
                            }
                        }
                    } else {
                        Swal.fire('Error', result.message || 'Failed to add address', 'error');
                    }
                } catch (error) {
                    console.error('Error adding address:', error);
                    Swal.fire('Error', 'Failed to add address', 'error');
                }
            });

            // Coupon code application
            const applyCouponBtn = document.getElementById('applyCouponBtn');
            const couponCodeInput = document.getElementById('couponCode');
            const couponMessage = document.getElementById('couponMessage');
            const discountSection = document.getElementById('discountSection');
            const discountAmount = document.getElementById('discountAmount');
            const finalTotal = document.getElementById('finalTotal');

            // Initialize variables for coupon application

            applyCouponBtn.addEventListener('click', applyCoupon);

            async function applyCoupon() {
                const couponCode = couponCodeInput.value.trim();
                const subtotal = parseFloat('<%= subtotal %>');
                const shipping = parseFloat('<%= shipping %>');
                const tax = parseFloat('<%= tax %>');
                const currentTotal = subtotal + shipping + tax;

                if (!couponCode) {
                    showCouponError('Please enter a coupon code.');
                    return;
                }

                try {
                    const response = await fetch('/apply-coupon', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: couponCode,
                            cartTotal: subtotal, // Pass subtotal without shipping/tax
                            userId: '<%= user._id %>'
                        }),
                    });

                    const data = await response.json();

                    if (data.success) {
                        appliedCoupon = {
                            code: data.coupon.code,
                            couponId: data.coupon.id, // Using 'id' as sent from the server
                            discount: data.discount,
                            finalAmount: currentTotal - data.discount
                        };

                        // Update checkout data with coupon information
                        checkoutData.couponCode = data.coupon.code;
                        console.log("Applied coupon:", appliedCoupon);
                        console.log("Checkout data:", checkoutData);

                        // Store coupon ID for debugging
                        localStorage.setItem('lastAppliedCouponId', data.coupon.id || '');

                        updateOrderSummary(data.discount, appliedCoupon.finalAmount);
                        couponMessage.textContent = data.message;
                        couponMessage.className = "text-sm mt-2 text-green-600";
                    } else {
                        showCouponError(data.message);
                    }
                } catch (error) {
                    console.error('Error applying coupon:', error);
                    showCouponError('Something went wrong. Try again later.');
                }
            }

            function updateOrderSummary(discount, finalAmount) {
                discountSection.classList.remove('hidden');
                discountAmount.textContent = `-$${discount.toFixed(2)}`;
                finalTotal.textContent = `$${finalAmount.toFixed(2)}`;
            }

            function showCouponError(message) {
                couponMessage.textContent = message;
                couponMessage.className = "text-sm mt-2 text-red-600";
                discountSection.classList.add('hidden');
                finalTotal.textContent = `$${(parseFloat('<%= subtotal %>') + parseFloat('<%= shipping %>') + parseFloat('<%= tax %>')).toFixed(2)}`;
                appliedCoupon = null;
                checkoutData.couponCode = null; // Reset coupon in checkout data
            }
        });

        // Function to select an address
        function selectAddress(addressId) {
            // Remove selected class from all address cards
            document.querySelectorAll('.address-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selected class to the clicked card
            const selectedCard = document.querySelector(`[data-address-id="${addressId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedAddressId = addressId;
                checkoutData.addressId = addressId;
            }
        }

        // Function to select a payment method
        function selectPaymentMethod(method) {
            // Remove selected class from all payment methods
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('selected');
            });

            // Add selected class to the clicked method
            const selectedMethod = document.querySelector(`[data-method="${method}"]`);
            if (selectedMethod) {
                selectedMethod.classList.add('selected');
                document.getElementById(method).checked = true;
                selectedPaymentMethod = method;
            }
        }

        // Function to navigate between steps
        function goToStep(step) {
            document.getElementById('addressStep').classList.add('hidden');
            document.getElementById('paymentStep').classList.add('hidden');
            document.getElementById('reviewStep').classList.add('hidden');

            if (step === 1) {
                document.getElementById('addressStep').classList.remove('hidden');
            } else if (step === 2) {
                document.getElementById('paymentStep').classList.remove('hidden');
            } else if (step === 3) {
                document.getElementById('reviewStep').classList.remove('hidden');
            }
        }

        // Function to update the review step with selected options
        function updateReviewStep() {
            // Update selected address display
            const selectedAddressCard = document.querySelector(`[data-address-id="${selectedAddressId}"]`);
            if (selectedAddressCard) {
                document.getElementById('selectedAddressDisplay').innerHTML = selectedAddressCard.innerHTML;
            }

            // Update payment method display
            let paymentMethodText = '';
            if (selectedPaymentMethod === 'cod') {
                paymentMethodText = 'Cash on Delivery (Pay when you receive your order)';
            } else if (selectedPaymentMethod === 'razorpay') {
                paymentMethodText = 'Razorpay (Secure online payment)';
            } else if (selectedPaymentMethod === 'wallet') {
                paymentMethodText = `Wallet Balance ($<%= user.wallet ? user.wallet.toFixed(2) : '0.00' %> available)`;
            }
            document.getElementById('selectedPaymentDisplay').innerHTML = `
                <p class="font-medium">${paymentMethodText}</p>
            `;

            // Update checkout data with coupon information
            if (appliedCoupon) {
                checkoutData.couponCode = appliedCoupon.code;
            } else {
                checkoutData.couponCode = null;
            }
        }

        // Function to show address modal
        function showAddressModal() {
            document.getElementById('addressModal').classList.remove('hidden');
        }

        // Function to hide address modal
        function hideAddressModal() {
            document.getElementById('addressModal').classList.add('hidden');
        }

        // Function to place the order
        async function placeOrder() {
            if (!selectedAddressId || !selectedPaymentMethod) {
                Swal.fire('Error', 'Please complete all checkout steps', 'error');
                return;
            }

            // Log the order data for debugging
            console.log("Placing order with data:", {
                paymentMethod: selectedPaymentMethod,
                addressId: selectedAddressId,
                couponCode: checkoutData.couponCode
            });

            // Show loading overlay
            showLoadingOverlay();

            try {
                const response = await fetch('/checkout/place-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentMethod: selectedPaymentMethod,
                        addressId: selectedAddressId,
                        couponCode: checkoutData.couponCode
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error("Server error response:", result);
                    let errorMessage = result.message || `HTTP error! status: ${response.status}`;

                    // If there's a more detailed error message, use it
                    if (result.error) {
                        console.error("Detailed error:", result.error);
                        errorMessage += ` - ${result.error}`;
                    }

                    throw new Error(errorMessage);
                }

                if (result.success) {
                    // If payment method is Razorpay, initiate Razorpay payment
                    if (selectedPaymentMethod === 'razorpay') {
                        // Hide loading overlay temporarily
                        hideLoadingOverlay();

                        // Create Razorpay order
                        try {
                            console.log('Creating Razorpay order for order ID:', result.orderId);

                            const razorpayResponse = await fetch('/razorpay/create-order', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    orderId: result.orderId
                                })
                            });

                            const razorpayResult = await razorpayResponse.json();
                            console.log('Razorpay create order response:', razorpayResult);

                            if (!razorpayResponse.ok) {
                                console.error('Razorpay order creation failed:', razorpayResult);
                                throw new Error(razorpayResult.message || razorpayResult.error || 'Failed to create Razorpay order');
                            }

                            // Initialize Razorpay checkout
                            console.log('Initializing Razorpay checkout with key:', '<%= razorpayKeyId %>');

                            // Ensure we have all required data
                            if (!razorpayResult.order || !razorpayResult.order.id || !razorpayResult.order.amount) {
                                console.error('Missing required Razorpay order data:', razorpayResult);
                                throw new Error('Invalid Razorpay order data received from server');
                            }

                            // Make sure we have a valid Razorpay key
                            const razorpayKey = '<%= razorpayKeyId %>';
                            console.log('Using Razorpay key:', razorpayKey);

                            // Validate Razorpay key
                            if (!razorpayKey || razorpayKey.trim() === '') {
                                throw new Error('Razorpay key is missing or invalid');
                            }

                            // Get contact information from the selected address
                            let contactNumber = '<%= user.mobile || "" %>';
                            try {
                                const selectedAddressElement = document.querySelector(`[data-address-id="${selectedAddressId}"]`);
                                if (selectedAddressElement) {
                                    const mobileText = selectedAddressElement.textContent.match(/Mobile: (\d+)/);
                                    if (mobileText && mobileText[1]) {
                                        contactNumber = mobileText[1];
                                        console.log('Found contact number from address:', contactNumber);
                                    }
                                }
                            } catch (e) {
                                console.error('Error getting contact from address:', e);
                            }

                            const options = {
                                key: razorpayKey, // Get from server
                                amount: razorpayResult.order.amount,
                                currency: razorpayResult.order.currency || 'INR',
                                name: 'Mangeyko',
                                description: 'Purchase from Mangeyko',
                                order_id: razorpayResult.order.id,
                                image: 'https://i.imgur.com/3g7nmJC.png', // Add your logo URL here
                                notes: {
                                    order_id: result.orderId,
                                    customer_name: '<%= user.name %>'
                                },
                                handler: async function(response) {
                                    console.log('Razorpay payment successful:', response);
                                    // Show loading overlay again
                                    showLoadingOverlay();

                                    // Verify payment with server
                                    try {
                                        // Validate response
                                        if (!response.razorpay_order_id || !response.razorpay_payment_id || !response.razorpay_signature) {
                                            throw new Error('Invalid payment response from Razorpay');
                                        }

                                        console.log('Verifying payment with server...');
                                        const verifyResponse = await fetch('/razorpay/verify-payment', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({
                                                razorpay_order_id: response.razorpay_order_id,
                                                razorpay_payment_id: response.razorpay_payment_id,
                                                razorpay_signature: response.razorpay_signature,
                                                order_id: result.orderId
                                            })
                                        });

                                        const verifyResult = await verifyResponse.json();
                                        console.log('Payment verification result:', verifyResult);

                                        if (verifyResult.success) {
                                            // Hide loading overlay before showing success message
                                            hideLoadingOverlay();

                                            // Redirect to payment success page
                                            window.location.href = `/payment/success/${result.orderId}?paymentId=${response.razorpay_payment_id}`;
                                        } else {
                                            throw new Error(verifyResult.message || verifyResult.error || 'Payment verification failed');
                                        }
                                    } catch (error) {
                                        console.error('Payment verification error:', error);
                                        hideLoadingOverlay();

                                        // Redirect to payment failure page
                                        const errorMessage = encodeURIComponent(error.message || 'Payment verification failed');
                                        window.location.href = `/payment/failure/${result.orderId}?error=${errorMessage}`;
                                    }
                                },
                                prefill: {
                                    name: '<%= user.name %>',
                                    email: '<%= user.email %>',
                                    contact: contactNumber
                                },
                                theme: {
                                    color: '#000000'
                                },
                                modal: {
                                    ondismiss: function() {
                                        hideLoadingOverlay();
                                        // Redirect to payment failure page with cancelled message
                                        const errorMessage = encodeURIComponent('Payment was cancelled. You can retry payment from your order details page.');
                                        window.location.href = `/payment/failure/${result.orderId}?error=${errorMessage}`;
                                    }
                                }
                            };

                            const rzp = new Razorpay(options);
                            rzp.open();

                            // Add a safety timeout to hide the loading overlay after 60 seconds
                            // in case something goes wrong and it doesn't get hidden properly
                            setTimeout(() => {
                                if (document.getElementById('loadingOverlay').style.display === 'flex') {
                                    console.log('Safety timeout: Hiding loading overlay after 60 seconds');
                                    hideLoadingOverlay();
                                }
                            }, 60000);

                        } catch (razorpayError) {
                            console.error('Razorpay error:', razorpayError);
                            hideLoadingOverlay();

                            // Get error message
                            let errorMessage = 'Failed to initialize payment';

                            if (razorpayError.message) {
                                errorMessage = razorpayError.message;
                            }

                            // Log additional details for debugging
                            console.log('Order ID:', result.orderId);
                            console.log('Payment method:', selectedPaymentMethod);
                            console.log('Razorpay key:', '<%= razorpayKeyId %>');

                            // Redirect to payment failure page
                            const encodedError = encodeURIComponent(errorMessage);
                            window.location.href = `/payment/failure/${result.orderId}?error=${encodedError}`;
                        }
                    } else {
                        // For non-Razorpay payments, redirect to order confirmation page
                        window.location.href = `/orders/${result.orderId}`;
                    }
                } else {
                    // Hide loading overlay
                    hideLoadingOverlay();

                    if (result.redirect) {
                        window.location.href = result.redirect;
                    } else {
                        Swal.fire('Error', result.message || 'Failed to place order', 'error');
                    }
                }
            } catch (error) {
                console.error('Error placing order:', error);
                hideLoadingOverlay();
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to place order. Please try again later.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    </script>
</body>
</html>