<%- include("partials/header", { activePage: 'reports' }) %>

<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Sales Report</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="/admin/sales-report/download?filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>"
               class="btn btn-sm btn-outline-secondary me-2">
                <i class="fas fa-file-csv"></i> Export CSV
            </a>
            <a href="/admin/sales-report/download-pdf?filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>"
               class="btn btn-sm btn-outline-danger me-2">
                <i class="fas fa-file-pdf"></i> Export PDF
            </a>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Filter Sales Data</h5>
        </div>
        <div class="card-body">
            <form id="filterForm" action="/admin/sales-report" method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="filter" class="form-label">Time Period</label>
                    <select class="form-select" id="filter" name="filter">
                        <option value="today" <%= filters.filter === 'today' ? 'selected' : '' %>>Today</option>
                        <option value="this_week" <%= filters.filter === 'this_week' ? 'selected' : '' %>>This Week</option>
                        <option value="this_month" <%= filters.filter === 'this_month' ? 'selected' : '' %>>This Month</option>
                        <option value="this_year" <%= filters.filter === 'this_year' ? 'selected' : '' %>>This Year</option>
                        <option value="all_time" <%= filters.filter === 'all_time' ? 'selected' : '' %>>All Time</option>
                        <option value="custom" <%= filters.filter === 'custom' ? 'selected' : '' %>>Custom Range</option>
                    </select>
                </div>
                <div class="col-md-3 custom-date-range <%= filters.filter !== 'custom' ? 'd-none' : '' %>">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" value="<%= filters.startDate %>">
                </div>
                <div class="col-md-3 custom-date-range <%= filters.filter !== 'custom' ? 'd-none' : '' %>">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" value="<%= filters.endDate %>">
                </div>
                <div class="col-md-3">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod" name="paymentMethod">
                        <option value="all" <%= filters.paymentMethod === 'all' ? 'selected' : '' %>>All Methods</option>
                        <option value="cod" <%= filters.paymentMethod === 'cod' ? 'selected' : '' %>>Cash on Delivery</option>
                        <option value="razorpay" <%= filters.paymentMethod === 'razorpay' ? 'selected' : '' %>>Razorpay</option>
                        <option value="wallet" <%= filters.paymentMethod === 'wallet' ? 'selected' : '' %>>Wallet</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="orderStatus" class="form-label">Order Status</label>
                    <select class="form-select" id="orderStatus" name="orderStatus">
                        <option value="all" <%= filters.orderStatus === 'all' ? 'selected' : '' %>>All Statuses</option>
                        <option value="Processing" <%= filters.orderStatus === 'Processing' ? 'selected' : '' %>>Processing</option>
                        <option value="Shipped" <%= filters.orderStatus === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                        <option value="Delivered" <%= filters.orderStatus === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                        <option value="Cancelled" <%= filters.orderStatus === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                        <option value="Returned" <%= filters.orderStatus === 'Returned' ? 'selected' : '' %>>Returned</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy" name="sortBy">
                        <option value="date" <%= filters.sortBy === 'date' ? 'selected' : '' %>>Date</option>
                        <option value="amount" <%= filters.sortBy === 'amount' ? 'selected' : '' %>>Amount</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortOrder" class="form-label">Sort Order</label>
                    <select class="form-select" id="sortOrder" name="sortOrder">
                        <option value="desc" <%= filters.sortOrder === 'desc' ? 'selected' : '' %>>Descending</option>
                        <option value="asc" <%= filters.sortOrder === 'asc' ? 'selected' : '' %>>Ascending</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="limit" class="form-label">Items Per Page</label>
                    <select class="form-select" id="limit" name="limit">
                        <option value="10" <%= pagination.limit === 10 ? 'selected' : '' %>>10</option>
                        <option value="25" <%= pagination.limit === 25 ? 'selected' : '' %>>25</option>
                        <option value="50" <%= pagination.limit === 50 ? 'selected' : '' %>>50</option>
                        <option value="100" <%= pagination.limit === 100 ? 'selected' : '' %>>100</option>
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="/admin/sales-report" class="btn btn-secondary">Reset</a>
                    <a href="/admin/sales-report/download?<%= Object.entries(filters).map(([key, value]) => `${key}=${value}`).join('&') %>&limit=<%= pagination.limit %>" class="btn btn-success">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </a>
                    <a href="/admin/sales-report/download-pdf?<%= Object.entries(filters).map(([key, value]) => `${key}=${value}`).join('&') %>&limit=<%= pagination.limit %>" class="btn btn-danger">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterSelect = document.getElementById('filter');
            const customDateRangeFields = document.querySelectorAll('.custom-date-range');

            filterSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDateRangeFields.forEach(field => field.classList.remove('d-none'));
                } else {
                    customDateRangeFields.forEach(field => field.classList.add('d-none'));
                }
            });
        });
    </script>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Sales</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₹<%= summary.totalSales ? summary.totalSales.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></div>
                            <div class="small text-muted">Original: ₹<%= summary.totalOriginalValue ? summary.totalOriginalValue.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-rupee-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Orders</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800"><%= summary.totalOrders || 0 %></div>
                            <div class="small text-muted">Products: <%= summary.totalProducts || 0 %></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Total Discount</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">₹<%= summary.totalDiscount ? summary.totalDiscount.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></div>
                            <div class="small text-success"><%= summary.discountPercentage ? summary.discountPercentage.toFixed(1) : '0.0' %>% off</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tags fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Average Order Value</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                ₹<%= summary.avgOrderValue ? summary.avgOrderValue.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calculator fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Tables Row -->
    <div class="row mb-4">
        <!-- Payment Method Summary Table -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Payment Method Summary</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Payment Method</th>
                                    <th>Orders</th>
                                    <th>Total Amount</th>
                                    <th>Average Order Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Cash on Delivery</td>
                                    <td><%= paymentSummary.cod ? paymentSummary.cod.count || 0 : 0 %></td>
                                    <td>₹<%= paymentSummary.cod && paymentSummary.cod.total ? paymentSummary.cod.total.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                    <td>₹<%= paymentSummary.cod && paymentSummary.cod.avg ? paymentSummary.cod.avg.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                </tr>
                                <tr>
                                    <td>Razorpay</td>
                                    <td><%= paymentSummary.razorpay ? paymentSummary.razorpay.count || 0 : 0 %></td>
                                    <td>₹<%= paymentSummary.razorpay && paymentSummary.razorpay.total ? paymentSummary.razorpay.total.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                    <td>₹<%= paymentSummary.razorpay && paymentSummary.razorpay.avg ? paymentSummary.razorpay.avg.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                </tr>
                                <tr>
                                    <td>Wallet</td>
                                    <td><%= paymentSummary.wallet ? paymentSummary.wallet.count || 0 : 0 %></td>
                                    <td>₹<%= paymentSummary.wallet && paymentSummary.wallet.total ? paymentSummary.wallet.total.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                    <td>₹<%= paymentSummary.wallet && paymentSummary.wallet.avg ? paymentSummary.wallet.avg.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Total</strong></td>
                                    <td><strong><%= summary.totalOrders || 0 %></strong></td>
                                    <td><strong>₹<%= summary.totalSales ? summary.totalSales.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></strong></td>
                                    <td><strong>₹<%= summary.avgOrderValue ? summary.avgOrderValue.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status Distribution -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Order Status Distribution</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>Revenue</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (statusDistribution && statusDistribution.length > 0) { %>
                                    <% let totalCount = statusDistribution.reduce((sum, status) => sum + status.count, 0); %>
                                    <% statusDistribution.forEach(status => { %>
                                        <tr>
                                            <td>
                                                <% let badgeClass = 'bg-secondary'; %>
                                                <% if (status.status === 'Delivered') badgeClass = 'bg-success'; %>
                                                <% if (status.status === 'Processing') badgeClass = 'bg-primary'; %>
                                                <% if (status.status === 'Shipped') badgeClass = 'bg-info'; %>
                                                <% if (status.status === 'Cancelled') badgeClass = 'bg-danger'; %>
                                                <% if (status.status === 'Returned') badgeClass = 'bg-warning'; %>
                                                <span class="badge <%= badgeClass %>"><%= status.status %></span>
                                            </td>
                                            <td><%= status.count %></td>
                                            <td>₹<%= status.revenue ? status.revenue.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                            <td><%= ((status.count / totalCount) * 100).toFixed(1) %>%</td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4" class="text-center">No status data available</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Products Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Top Selling Products</h6>
            <% if (productsPagination.totalPages > 1) { %>
                <span class="small text-muted">Page <%= productsPagination.page %> of <%= productsPagination.totalPages %></span>
            <% } %>
        </div>
        <div id="top-products-container" class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Original Price</th>
                            <th>Discount</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (topProducts && topProducts.length > 0) { %>
                            <% topProducts.forEach(product => { %>
                                <tr>
                                    <td>
                                        <% if (product.image) { %>
                                            <img src="/uploads/products/<%= product.image %>" alt="<%= product.name %>" width="40" height="40" class="me-2 rounded">
                                        <% } %>
                                        <strong><%= product.name %></strong>
                                    </td>
                                    <td><%= product.quantity %></td>
                                    <td>₹<%= product.originalPrice ? product.originalPrice.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></td>
                                    <td>
                                        <% if (product.offerPercentage && product.offerPercentage > 0) { %>
                                            <span class="badge bg-success"><%= product.offerPercentage %>% OFF</span>
                                            <div class="small text-success">₹<%= product.totalDiscount ? product.totalDiscount.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %> saved</div>
                                        <% } else { %>
                                            <span class="text-muted">No discount</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <strong>₹<%= product.revenue ? product.revenue.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></strong>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" class="text-center">No products found</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination for Top Products -->
            <% if (productsPagination.totalPages > 1 || productsPagination.totalItems > 0) { %>
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        Showing <%= (productsPagination.page - 1) * productsPagination.limit + 1 %> to
                        <%= Math.min(productsPagination.page * productsPagination.limit, productsPagination.totalItems) %>
                        of <%= productsPagination.totalItems %> products
                    </div>
                    <div class="d-flex align-items-center">
                        <label for="productsLimit" class="me-2 mb-0">Show:</label>
                        <select id="productsLimit" class="form-select form-select-sm" style="width: auto;">
                            <option value="5" <%= productsPagination.limit === 5 ? 'selected' : '' %>>5</option>
                            <option value="10" <%= productsPagination.limit === 10 ? 'selected' : '' %>>10</option>
                            <option value="25" <%= productsPagination.limit === 25 ? 'selected' : '' %>>25</option>
                            <option value="50" <%= productsPagination.limit === 50 ? 'selected' : '' %>>50</option>
                        </select>
                    </div>
                </div>
                <nav aria-label="Page navigation" class="products-pagination">
                    <ul class="pagination">
                        <li class="page-item <%= productsPagination.page === 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?productsPage=<%= productsPagination.page - 1 %>&page=<%= pagination.page %>&filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>&limit=<%= pagination.limit %>&productsLimit=<%= productsPagination.limit %>">Previous</a>
                        </li>

                        <% for(let i = 1; i <= productsPagination.totalPages; i++) { %>
                            <% if (
                                i === 1 ||
                                i === productsPagination.totalPages ||
                                (i >= productsPagination.page - 1 && i <= productsPagination.page + 1)
                            ) { %>
                                <li class="page-item <%= productsPagination.page === i ? 'active' : '' %>">
                                    <a class="page-link" href="?productsPage=<%= i %>&page=<%= pagination.page %>&filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>&limit=<%= pagination.limit %>&productsLimit=<%= productsPagination.limit %>"><%= i %></a>
                                </li>
                            <% } else if (
                                (i === 2 && productsPagination.page > 3) ||
                                (i === productsPagination.totalPages - 1 && productsPagination.page < productsPagination.totalPages - 2)
                            ) { %>
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            <% } %>
                        <% } %>

                        <li class="page-item <%= productsPagination.page === productsPagination.totalPages ? 'disabled' : '' %>">
                            <a class="page-link" href="?productsPage=<%= productsPagination.page + 1 %>&page=<%= pagination.page %>&filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>&limit=<%= pagination.limit %>&productsLimit=<%= productsPagination.limit %>">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <% } %>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Order Details</h6>
            <% if (pagination.totalPages > 1) { %>
                <span class="small text-muted">Page <%= pagination.page %> of <%= pagination.totalPages %></span>
            <% } %>
        </div>
        <div id="orders-container" class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Payment Method</th>
                            <th>Items</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (orders && orders.length > 0) { %>
                            <% orders.forEach(order => { %>
                                <tr>
                                    <td>
                                        <span class="fw-medium">Order #<%= order.orderNumber || order.orderId %></span>
                                        <div class="small text-muted">ID: <%= order._id.toString().substring(0, 8) %></div>
                                    </td>
                                    <td><%= order.formattedOrderDate %></td>
                                    <td><%= order.customerName %></td>
                                    <td><%= order.paymentMethod ? order.paymentMethod.toUpperCase() : 'UNKNOWN' %></td>
                                    <td><%= order.itemCount %> items</td>
                                    <td>
                                        <strong>₹<%= order.finalAmount ? order.finalAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 }) : '0.00' %></strong>
                                        <% if (order.totalDiscount && order.totalDiscount > 0) { %>
                                            <div class="small text-success">
                                                <i class="fas fa-tags"></i> <%= order.discountPercentage || 0 %>% off
                                                (₹<%= order.totalDiscount.toLocaleString('en-IN', { maximumFractionDigits: 2 }) %> saved)
                                            </div>
                                        <% } %>
                                    </td>
                                    <td>
                                        <%
                                        let statusCounts = {};
                                        order.orderedItems.forEach(item => {
                                            statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
                                        });

                                        Object.entries(statusCounts).forEach(([status, count]) => {
                                            let badgeClass = 'bg-secondary';
                                            if (status === 'Delivered') badgeClass = 'bg-success';
                                            if (status === 'Processing') badgeClass = 'bg-primary';
                                            if (status === 'Shipped') badgeClass = 'bg-info';
                                            if (status === 'Cancelled') badgeClass = 'bg-danger';
                                            if (status === 'Returned') badgeClass = 'bg-warning';
                                        %>
                                            <span class="badge <%= badgeClass %> me-1"><%= status %> (<%= count %>)</span>
                                        <% }); %>
                                    </td>
                                    <td>
                                        <a href="/admin/orders/<%= order._id %>" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center">No orders found</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>

                <!-- Pagination -->
                <% if (pagination.totalPages > 1) { %>
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            Showing <%= (pagination.page - 1) * pagination.limit + 1 %> to
                            <%= Math.min(pagination.page * pagination.limit, pagination.totalItems) %>
                            of <%= pagination.totalItems %> entries
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="ordersLimit" class="me-2 mb-0">Show:</label>
                            <select id="ordersLimit" class="form-select form-select-sm" style="width: auto;">
                                <option value="10" <%= pagination.limit === 10 ? 'selected' : '' %>>10</option>
                                <option value="25" <%= pagination.limit === 25 ? 'selected' : '' %>>25</option>
                                <option value="50" <%= pagination.limit === 50 ? 'selected' : '' %>>50</option>
                                <option value="100" <%= pagination.limit === 100 ? 'selected' : '' %>>100</option>
                            </select>
                        </div>
                    </div>
                    <nav aria-label="Page navigation" class="orders-pagination">
                        <ul class="pagination">
                            <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
                                <a class="page-link" href="?page=<%= pagination.page - 1 %>&productsPage=<%= productsPagination.page %>&filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>&limit=<%= pagination.limit %>&productsLimit=<%= productsPagination.limit %>">Previous</a>
                            </li>

                            <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                <% if (
                                    i === 1 ||
                                    i === pagination.totalPages ||
                                    (i >= pagination.page - 1 && i <= pagination.page + 1)
                                ) { %>
                                    <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %>&productsPage=<%= productsPagination.page %>&filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>&limit=<%= pagination.limit %>&productsLimit=<%= productsPagination.limit %>"><%= i %></a>
                                    </li>
                                <% } else if (
                                    (i === 2 && pagination.page > 3) ||
                                    (i === pagination.totalPages - 1 && pagination.page < pagination.totalPages - 2)
                                ) { %>
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                <% } %>
                            <% } %>

                            <li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>">
                                <a class="page-link" href="?page=<%= pagination.page + 1 %>&productsPage=<%= productsPagination.page %>&filter=<%= filters.filter %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>&paymentMethod=<%= filters.paymentMethod %>&orderStatus=<%= filters.orderStatus %>&sortBy=<%= filters.sortBy %>&sortOrder=<%= filters.sortOrder %>&limit=<%= pagination.limit %>&productsLimit=<%= productsPagination.limit %>">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<%- include("partials/footer") %>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize AJAX pagination for top products
        initializeAjaxPagination('products-pagination', 'top-products-container', 'productsPage');

        // Initialize AJAX pagination for orders
        initializeAjaxPagination('orders-pagination', 'orders-container', 'page');

        // Initialize AJAX for products limit change
        document.getElementById('productsLimit')?.addEventListener('change', function() {
            loadPageWithAjax({
                productsLimit: this.value,
                productsPage: 1
            });
        });

        // Initialize AJAX for orders limit change
        document.getElementById('ordersLimit')?.addEventListener('change', function() {
            loadPageWithAjax({
                limit: this.value,
                page: 1
            });
        });
    });

    // Function to initialize AJAX pagination for a container
    function initializeAjaxPagination(paginationContainerClass, contentContainerId, pageParamName) {
        document.querySelectorAll(`.${paginationContainerClass} .page-link`).forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // Extract page number from URL
                const url = new URL(this.href);
                const pageNumber = url.searchParams.get(pageParamName);

                // Create params object with just the page parameter
                const params = {};
                params[pageParamName] = pageNumber;

                // Load the page with AJAX
                loadPageWithAjax(params);
            });
        });
    }

    // Function to load page content with AJAX
    function loadPageWithAjax(params) {
        // Show loading spinner
        document.body.classList.add('loading');

        // Get current URL and update with new params
        const currentUrl = new URL(window.location.href);

        // Update URL with new params
        Object.keys(params).forEach(key => {
            currentUrl.searchParams.set(key, params[key]);
        });

        // Update browser history without refreshing
        window.history.pushState({}, '', currentUrl.toString());

        // Fetch the new content
        fetch(currentUrl.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Create a temporary element to parse the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Update top products content if it exists
            const newTopProductsContent = tempDiv.querySelector('#top-products-container');
            if (newTopProductsContent) {
                document.getElementById('top-products-container').innerHTML = newTopProductsContent.innerHTML;

                // Re-initialize pagination for top products
                initializeAjaxPagination('products-pagination', 'top-products-container', 'productsPage');
            }

            // Update orders content if it exists
            const newOrdersContent = tempDiv.querySelector('#orders-container');
            if (newOrdersContent) {
                document.getElementById('orders-container').innerHTML = newOrdersContent.innerHTML;

                // Re-initialize pagination for orders
                initializeAjaxPagination('orders-pagination', 'orders-container', 'page');
            }

            // Hide loading spinner
            document.body.classList.remove('loading');
        })
        .catch(error => {
            console.error('Error loading content:', error);
            document.body.classList.remove('loading');

            // Show error message
            Swal.fire({
                title: 'Error',
                text: 'Failed to load content. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    }
</script>

<style>
    /* Loading spinner styles */
    body.loading::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 9999;
    }

    body.loading::before {
        content: '';
        position: fixed;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        margin-top: -25px;
        margin-left: -25px;
        border-radius: 50%;
        border: 5px solid #f3f3f3;
        border-top-color: #3498db;
        animation: spin 1s linear infinite;
        z-index: 10000;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>